---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import HubSearchBar from '../../components/organisms/HubSearchBar';
import FeaturedCard from '../../components/molecules/FeaturedCard.astro';
import ReviewCard from '../../components/molecules/ReviewCard.astro';
import FAQAccordion from '../../components/molecules/FAQAccordion';
import { Button } from '../../components/atoms/Button';

export async function getStaticPaths() {
  return [
    { params: { hub: 'reviews' } },
    { params: { hub: 'comparisons' } },
    { params: { hub: 'news' } },
  ];
}

const { hub } = Astro.params;
const collectionName = hub as 'reviews' | 'comparisons' | 'news';

// 1. Fetch Data
// @ts-ignore - Dynamic collection type
const allPosts = await getCollection(collectionName);

// 2. Sort & Filter for Vanguard
const sortedPosts = allPosts.sort((a, b) => {
    // @ts-ignore
    if (a.data.featured && !b.data.featured) return -1;
    // @ts-ignore
    if (!a.data.featured && b.data.featured) return 1;
    // @ts-ignore
    const ratingA = a.data.rating || 0; 
    // @ts-ignore
    const ratingB = b.data.rating || 0;
    return ratingB - ratingA;
});

const vanguardPosts = sortedPosts.slice(0, 3);
const feedPosts = sortedPosts.slice(3);

// 3. Metadata & Content Config
const config = {
    reviews: {
        title: "In-Depth D&D Adventure Critiques",
        about: "Our reviews are more than just opinions; they are deep dives into the mechanics, narrative structure, and value proposition of every D&D product. We playtest significantly to differentiate between what looks good on paper and what actually works at the table.",
        faqs: [
            { question: "How do you rate adventures?", answer: "We use a 10-point scale focusing on Playability (DM prep time), Organization (information flow), and Value (content per dollar). A 5/10 is average, meaning it requires significant work to run smoothly." },
            { question: "Do you accept sponsored reviews?", answer: "No. All books are purchased with our own gold pieces to ensure 100% impartiality. If a publisher sends us a copy, we disclose it immediately, but it does not affect the score." },
            { question: "What is the 'DM Preparation' score?", answer: "This metrics estimates how many hours of prep work you need per hour of gameplay. A high score means the book is 'run-out-of-the-box' ready." }
        ]
    },
    comparisons: {
        title: "Side-by-Side D&D Comparisons",
        about: "D&D books are expensive. Our side-by-side comparisons break down content overlap, value for money, and target audience differences so you never buy a redundant book again. We focus on the 'opportunity cost' of your purchase.",
        faqs: [
            { question: "How do you choose the winner?", answer: "Winners are chosen based on specific use-cases. One book might win for 'Lore Depth' while the other wins for 'Player Options'. We define the criteria clearly at the start of every showdown." },
            { question: "Do you compare older editions?", answer: "Yes. With the 2024 updates, comparing 5e (2014) content with One D&D revisions is a major focus to help you decide if upgrading is worth the cost." },
            { question: "Are third-party books included?", answer: "Absolutely. We often compare official Wizards of the Coast campaigns against top-tier third-party alternatives from publishers like Kobold Press or Ghostfire Gaming." }
        ]
    },
    news: {
        title: "The Latest from Wizards of the Coast",
        about: "Stay updated with the latest Wizards of the Coast releases, OGL updates, and community homebrew. We filter out the noise to bring you only the actionable news that affects your game table and the broader TTRPG industry.",
        faqs: [
            { question: "How often is news updated?", answer: "We post daily updates for major announcements and weekly roundups for community content. Our goal is signal, not noise." },
            { question: "Do you cover rumors/leaks?", answer: "Only if they come from credible sources with a track record of accuracy. We mark all unverified information clearly as 'Speculation' to avoid spreading misinformation." },
            { question: "Can I submit news tips?", answer: "Yes! If you are a creator launching a Kickstarter or have spotted a new errata, send a raven to our contact page." }
        ]
    }
};

const pageConfig = config[collectionName];

// Dynamic Filters
const uniqueCategories = [...new Set(allPosts.map((p: any) => p.data.category))].sort();
const categoryFilters = uniqueCategories.map((c: string) => ({ label: c.charAt(0).toUpperCase() + c.slice(1), value: c }));

// Helper to normalize card data
const getCardData = (post: any) => {
    if (collectionName === 'reviews') {
        return {
            title: post.data.title,
            description: post.data.description,
            coverImage: post.data.product?.coverImage || '/placeholder.jpg',
            rating: post.data.rating,
            category: post.data.category,
            slug: post.slug,
            price: post.data.product?.price
        };
    } else if (collectionName === 'comparisons') {
        return {
            title: post.data.title,
            description: post.data.description,
            coverImage: '/images/comparison-placeholder.jpg', // Placeholder for now
            rating: 0, // Comparisons don't have ratings
            category: post.data.category,
            slug: post.slug,
        };
    } else { // news
        return {
            title: post.data.title,
            description: post.data.excerpt,
            coverImage: post.data.image || '/placeholder.jpg',
            rating: 0,
            category: post.data.category,
            slug: post.slug,
        };
    }
};
---

<Layout title={pageConfig.title}>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    
    {/* 1. Header (Simplified) */}
    <header class="text-center mb-16">
        <h1 class="text-4xl md:text-6xl font-serif font-bold text-copper-950 mb-2">{pageConfig.title}</h1>
        <p class="text-copper-700 max-w-2xl mx-auto">The definitive archive for {collectionName}.</p>
    </header>

    {/* 2. The Vanguard Bento Cluster */}
    <section class="mb-24">
        <h2 class="text-2xl font-bold text-copper-900 mb-6 flex items-center gap-2">
            <span class="w-2 h-8 bg-copper-500 block"></span>
            The Vanguard (Top Picks)
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 grid-rows-2 gap-6 h-auto md:h-[600px]">
             {vanguardPosts[0] && (() => {
                 const data = getCardData(vanguardPosts[0]);
                 return (
                 <div class="md:col-span-2 md:row-span-2 h-full">
                     <FeaturedCard 
                        title={data.title}
                        description={data.description}
                        coverImage={data.coverImage}
                        rating={data.rating}
                        category={data.category}
                        slug={data.slug}
                        className="h-full"
                     />
                 </div>
                 );
             })()}
             
             {vanguardPosts.slice(1, 3).map((post) => {
                 const data = getCardData(post);
                 return (
                 <div class="md:col-span-1 md:row-span-1 h-full">
                     <ReviewCard 
                        title={data.title}
                        coverImage={data.coverImage}
                        rating={data.rating}
                        category={data.category}
                        slug={data.slug}
                        price={data.price}
                        className="h-full"
                     />
                 </div>
                 );
             })}
        </div>
    </section>

    {/* 3. Dynamic Post Feed w/ Search Bar */}
    <section class="mb-24">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <h2 class="text-2xl font-bold text-copper-900 flex items-center gap-2">
                <span class="w-8 h-1 bg-copper-950 block"></span>
                All Archives
            </h2>
            
            {/* Minimalist Search Bar Positioned Here */}
            <div class="w-full md:w-auto">
                <HubSearchBar 
                    client:load 
                    hubType={collectionName} 
                    availableFilters={{
                        categories: categoryFilters
                    }} 
                />
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {feedPosts.map((post) => {
                const data = getCardData(post);
                return (
                <ReviewCard 
                    title={data.title}
                    coverImage={data.coverImage}
                    rating={data.rating}
                    category={data.category}
                    slug={data.slug}
                    price={data.price}
                />
                );
            })}
        </div>
    </section>

    {/* 4. Silo Content Pillar (Footer) */}
    <footer class="border-t-2 border-copper-100 pt-16 pb-8">
        <div class="max-w-3xl mx-auto">
            <h3 class="font-serif text-2xl font-bold text-copper-950 mb-6">About {collectionName.charAt(0).toUpperCase() + collectionName.slice(1)}</h3>
            <div class="prose prose-copper text-copper-800 mb-8 p-6 bg-[#fdf9f0] border-l-4 border-copper-400 rounded-r-lg">
                <p>
                    {pageConfig.about}
                </p>
            </div>
            
            {/* FAQ Accordion */}
            <h4 class="font-serif text-xl font-bold text-copper-950 mb-4">Frequently Asked Questions</h4>
            <div class="min-h-[200px]">
                <FAQAccordion client:visible items={pageConfig.faqs} />
            </div>
        </div>
    </footer>

  </main>
</Layout>
