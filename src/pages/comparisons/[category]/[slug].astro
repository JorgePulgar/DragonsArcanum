---
import { getCollection, render } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Schema from '../../../components/utils/Schema.astro';
import ComparisonTable from '../../../components/organisms/ComparisonTable.astro';
import TableOfContents from '../../../components/molecules/TableOfContents.astro';
import OptimizedImage from '../../../components/atoms/OptimizedImage.astro';
import { Tag } from '../../../components/atoms/Tag';

export async function getStaticPaths() {
  const comparisons = await getCollection('comparisons');
  return comparisons.map(entry => {
    const slug = entry.id.split('/').pop()?.replace(/\.(md|mdx)$/, '') || entry.id;
    return {
      params: { category: entry.data.category, slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const { title, description, items, publishDate, winner } = entry.data;

// Prepare Schema (ItemList or Review?)
// Google recommends ItemList for summary pages, but if it's a comparison review, standard Review schema or Article is good.
// Let's use Article + ItemList?
const schema = {
  type: 'Article',
  data: {
    headline: title,
    description: description,
    datePublished: publishDate.toISOString(),
    author: {
        name: "The Adventure Vault"
    }
  }
};
---

<Layout title={title} description={description} article>
  <Schema schema={[schema]} />

  <article class="max-w-4xl mx-auto px-4 py-8">
     {/* Header: H1 -> Featured Image -> Intro */}
    <header class="mb-12 text-center max-w-3xl mx-auto">
      <div class="flex items-center justify-center gap-2 mb-4">
        <Tag label={entry.data.category} variant="accent" />
        <span class="text-sm text-copper-600 block">{publishDate.toLocaleDateString()}</span>
      </div>

      <h1 class="text-4xl md:text-6xl font-serif font-extrabold mb-6 text-copper-900 leading-tight text-balance">{title}</h1>
      
      {entry.data.image && (
        <div class="rounded-2xl overflow-hidden shadow-xl mb-8 border-4 border-copper-100">
           <OptimizedImage src={entry.data.image} alt={title} className="w-full h-auto object-cover aspect-video" loading="eager" />
        </div>
      )}
      
      <p class="text-xl text-copper-700 leading-relaxed mb-8 text-balance">
        {description}
      </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <div class="lg:col-span-12 prose prose-lg prose-headings:font-serif prose-headings:text-copper-900 prose-p:text-copper-800 max-w-none">
            {/* Table of Contents */}
            <TableOfContents headings={headings} />

            {/* Comparison Table */}
            <h2 class="text-3xl font-serif font-bold text-copper-900 mb-6">The Comparison</h2>
            <ComparisonTable items={items} />

            {/* Content */}
            <Content />

             {/* FAQ (Placeholder) */}
             {/* Recommended (Placeholder) */}
        </div>
    </div>
  </article>
</Layout>
