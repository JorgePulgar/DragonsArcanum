---
import { getCollection, render } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Schema from '../../../components/utils/Schema.astro';
import { ComparisonTable } from '../../../components/organisms/ComparisonTable';
import { Tag } from '../../../components/atoms/Tag';

export async function getStaticPaths() {
  const comparisons = await getCollection('comparisons');
  return comparisons.map(entry => {
    const slug = entry.id.split('/').pop()?.replace(/\.(md|mdx)$/, '') || entry.id;
    return {
      params: { category: entry.data.category, slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const { title, description } = entry.data;

// Transform data for ComparisonTable
// In a real app, we would fetch referenced reviews here to populate the table dynamically.
// For now, we use the items array directly from frontmatter.
const tableProducts = entry.data.items.map((item, index) => ({
  id: String(index),
  name: item.name,
  image: "/images/placeholder.jpg", // Needs resolution
  isWinner: entry.data.winner === item.name,
  data: {
    pros: item.pros,
    cons: item.cons,
    // Mocking other data as it's not in the Comparison frontmatter directly without lookup
    rating: 8 + index, 
    price: 49.99
  }
}));

const tableRows = [
  { label: 'Rating', key: 'rating', type: 'rating' },
  { label: 'Price', key: 'price', type: 'price' },
  { label: 'Pros', key: 'pros', type: 'list' },
  { label: 'Cons', key: 'cons', type: 'list' },
];

---

<Layout title={title} description={description} article>
  <div class="max-w-6xl mx-auto">
    <header class="text-center mb-12 max-w-3xl mx-auto">
      <Tag label="Comparison" className="mb-4" />
      <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight text-balance">{title}</h1>
      <p class="text-xl text-neutral-600 dark:text-neutral-400">{description}</p>
    </header>

    <ComparisonTable client:visible products={tableProducts} rows={tableRows} />

    <div class="prose prose-lg dark:prose-invert prose-neutral max-w-3xl mx-auto mt-12">
      <Content />
    </div>
  </div>
</Layout>
